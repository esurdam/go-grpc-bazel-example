# go-grpc-bazel-example

[![test](https://github.com/AdGreetz/go-grpc-bazel-example/actions/workflows/go.yml/badge.svg)](https://github.com/AdGreetz/go-grpc-bazel-example/actions/workflows/go.yml)

This repo is an example monorepo which utilizes grpc+bazel.

If proto implementation will be shared across services, implementation should reside in `pkg/`. Otherwise,
implementation can be included in `services/{{.packageName}}/pkg/`.

In this case, `helloworld` will be implemented in `pkg`.

- [Create new service](#create-a-new-service)
- [Development](#development)
- [Generating BUILD.bazel files](#generating-build-files)
- [Generating proto files](#generating-proto-files-(development))
- [Test locally](#test-repo)
- [Running locally](#running-service-locally)
- [Swagger + JSON Gateway](#swagger--json-gateway)
- [Deployment](#deployment)
- [Useful Links/Resources](#useful-links)

## Layout

```
.github/     # github Action CI configs
ci/          # contains ci/automation scripts
cmd/         # command line tool entrypoints
pb/          # contains all proto definitions and gen output
pkg/         # contains proto implementations
services/    # entrypoints for kubernetes defined microservices
tools/       # tool versioning
BUILD        # root bazel BUILD definitions; aggregates services
WORKSPACE    # bazel workspace rules; external code 
```

## Requirements

`Go` and `Bazel` are the only two requirements.

[Install Bazel](https://docs.bazel.build/versions/master/install.html)

## Create a new service

Create proto file and define types/service.

```bash
touch pb/helloworld/helloworld.proto # Add definitions to this file
```

Generate `BUILD.bazel` files which contain proto and library definitions, then run `make link` to add the generated
files locally.

```bash
make gazelle
make link
```

Implement proto service in `pkg`

```bash
mkdir pkg/helloworld/server
touch pkg/helloworld/server/server.go
```

Create service entrypoint in `services`

```bash
mkdir services/helloworld
touch services/helloworld/main.go
```

Define kubernetes service in `ci/services`

```bash
touch ci/services/helloworld.yml
```

Lastly, add the service definition to aggregate rule in `BUILD`.

## Development

Run make link to generate proto files locally for development access.

```bash
make link
```

## Generating BUILD files

Run `make gazelle` to generate/update BUILD files (which include test and binaries).

This also updates the WORKSPACE with required deps.

BUILD.bazel files located in pb directory will contain grpc rules.

## Generating proto files (development)

Generated files don't necessarily need to be checked in to repo. In this example, generated files are checked in. They
are only necessary for local development. Otherwise, Bazel will handle generating the pb file during build.

```bash
make link
```

## Test repo

To run all tests:

```bash
make test
```

Test individual package:

```bash
bazel test --features race \
  --verbose_failures \
  --test_output=errors \
  --action_env=CI=true \
  //pkg/helloworld/server:go_default_test
```

Tests can also be aggregated into test groups to be tested at once.

## Running service locally

```bash
bazel run //services/helloworld:helloworld -- -port 9000 -http-port 10000
```

Then we use cURL to send HTTP requests:

```bash
curl -X POST -k http://localhost:10000/v1/greeter -d '{"name": "TestName"}'
```

```json
{
  "message": "Hello TestName!"
}
```

You can view the swagger at [http://localhost:10000/swagger.json](http://localhost:10000/swagger.json)

### Client

With the server running, you can test command line tools from `cmd`. 
```text
$ bazel run //cmd/helloworld-client -- --name "Test Name" --server-addr :900
0

INFO: Analyzed target //cmd/helloworld-client:helloworld-client (1 packages loaded, 3 targets configured).
INFO: Found 1 target...
Target //cmd/helloworld-client:helloworld-client up-to-date:
  bazel-bin/cmd/helloworld-client/helloworld-client_/helloworld-client
INFO: Elapsed time: 0.327s, Critical Path: 0.10s
INFO: 2 processes: 1 internal, 1 darwin-sandbox.
INFO: Build completed successfully, 2 total actions
INFO: Running command line: bazel-bin/cmd/helloworld-client/helloworld-clien
INFO: Build completed successfully, 2 total actions

2022/06/26 02:29:31 message:"Hello Test Name!"
```

### Running with Docker locally

Each service should contain a `docker` rule, which builds the binary in a docker image:

```
go_image(
    name = "docker",
    embed = [
        ":helloworld_lib",
    ],
)
```

To run the binary in docker:

```bash
bazel run \
  --platforms=@io_bazel_rules_go//go/toolchain:linux_amd64 \
  --cpu=k8 \
  //services/helloworld:docker \
  -- --port 9000 --http-port 10000
```

## Swagger + JSON Gateway

Services may utilize `grpc-gateway` for a JSON-to-GRPC proxy. This is autogenerated with the `gateway_grpc_library` rule.
Swagger json is autogenerated via the `gateway_openapiv2_compile` rule.

```
load("@rules_proto_grpc//grpc-gateway:defs.bzl", "gateway_grpc_compile", "gateway_grpc_library", "gateway_openapiv2_compile")

gateway_grpc_library(
    name = "helloworld_gateway_lib_proto",
    importpath = "github.com/AdGreetz/go-grpc-bazel-example/pb/helloworld",
    protos = [":helloworld_proto"],
    visibility = ["//visibility:public"],
)

gateway_openapiv2_compile(
    name = "helloworld_gateway_grpc",
    protos = [":helloworld_proto"],
    visibility = ["//visibility:public"],
)
```

Services can then use the `go_embed_data` rule to embed the `swagger.json` compiled output.

```
# Embeds the swagger json as var "Data"
go_embed_data(
    name = "static_assets",
    src = "//pb/helloworld:helloworld_gateway_grpc",
    package = "main",
)
```

Services can then expose the `swagger.json` file directly. 

## Deployment

CI checks for formatting; ensure formatting with `make fmt`

```bash
make fmt
```

### Kubernetes deployment

Each service should contain a `k8s_deploy` rule, which defines the cluster deployment.

This rule builds the binary in Docker, pushes the image to the container registry, and deploys the service to the
defined Kubernetes cluster.

```
k8s_deploy(
    name = "k8s",
    images = {
        "services/helloworld:latest": "//services/helloworld:docker",
    },
    template = "//ci/services:helloworld.yaml",
)
```

Each service is expected to have an exported yaml file for configuration exposed in the `ci/services` directory.

To deploy services to k8s (local example):

```bash
SERVICE="helloworld"
export ENV="dev"

CLUSTER="docker-for-desktop-cluster"
NAMESPACE="development"
export PUSH_REPO="localhost:5000"

echo "deploying environment..."
echo "ENV: $ENV"
echo "NAMESPACE: $NAMESPACE"
echo "CLUSTER: $CLUSTER"
echo "SERVICE: $SERVICE"
echo "PUSH_REPO: $PUSH_REPO"

bazel run \
            --stamp \
            --workspace_status_command=./ci/status.sh \
            --define cluster="$CLUSTER" \
            --define namespace="$NAMESPACE" \
            --define env="$ENV" \
            --define version="$(openssl rand -base64 8 |md5 |head -c8)" \
            --platforms=@io_bazel_rules_go//go/toolchain:linux_amd64 \
            --cpu=k8 \
            "//services/helloworld:k8s.apply"
```

### Pushing service to container registry

Used to deploy a service to the container registry.

Each service should contain a `docker_push` rule, which defines the container registry and path.

```
docker_push(
    name = "push",
    image = ":docker",
    registry = "ghcr.io",
    repository = "adgreetz/go-grpc-bazel-example/services/helloworld",
    tag = "$(version)",
)
```

To push an individual service (where version is the container label):

```bash
bazel run \
  --define version="$(openssl rand -base64 8 |md5 |head -c8)" \ 
  --platforms=@io_bazel_rules_go//go/toolchain:linux_amd64 \
  --cpu=k8 \
  //services/helloworld:push
```

## Useful Links

GRPC

- [grpc-gateway](https://github.com/grpc-ecosystem/grpc-gateway)

Bazelbuild rules

- [rules_docker](https://github.com/bazelbuild/rules_docker)
- [rules_go](https://github.com/bazelbuild/rules_go)
- [rules_k8s](https://github.com/bazelbuild/rules_k8s)
- [rules_proto](https://github.com/bazelbuild/rules_proto)